<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1098px" preserveAspectRatio="none" style="width:724px;height:1098px;" version="1.1" viewBox="0 0 724 1098" width="724px" zoomAndPan="magnify"><defs><filter height="300%" id="ffex3ion6fd2u" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#ffex3ion6fd2u)" height="988.0625" style="stroke:#000000;stroke-width:2.0;" width="702" x="8" y="84.8906"/><rect fill="#FFFFFF" filter="url(#ffex3ion6fd2u)" height="473.6016" style="stroke:#000000;stroke-width:2.0;" width="552" x="27" y="273.0859"/><rect fill="#FFFFFF" height="111.2031" style="stroke:none;stroke-width:1.0;" width="552" x="27" y="635.4844"/><rect fill="#FFFFFF" filter="url(#ffex3ion6fd2u)" height="185.4688" style="stroke:#000000;stroke-width:2.0;" width="508" x="46" y="431.0156"/><rect fill="#FFFFFF" height="56.9375" style="stroke:none;stroke-width:1.0;" width="508" x="46" y="559.5469"/><rect fill="#FFFFFF" filter="url(#ffex3ion6fd2u)" height="250" style="stroke:#000000;stroke-width:2.0;" width="558" x="108" y="759.6875"/><rect fill="#FFFFFF" height="116.3359" style="stroke:none;stroke-width:1.0;" width="558" x="108" y="893.3516"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="124" x2="124" y1="72.8906" y2="1091.9531"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="300" x2="300" y1="72.8906" y2="1091.9531"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="524" x2="524" y1="72.8906" y2="1091.9531"/><rect fill="#FEFECE" filter="url(#ffex3ion6fd2u)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="87" x="78.5" y="21.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="106" y="41.292">Alice</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="85.5" y="57.5889">(Proposer)</text><rect fill="#FEFECE" filter="url(#ffex3ion6fd2u)" height="62.8906" style="stroke:#A80036;stroke-width:1.5;" width="104" x="246" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="38" x="279" y="24.9951">Ingrid</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="264" y="41.292">(Common</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="253" y="57.5889">Intermediary)</text><rect fill="#FEFECE" filter="url(#ffex3ion6fd2u)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="91" x="476.5" y="21.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="508" y="41.292">Bob</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="77" x="483.5" y="57.5889">(Proposee)</text><path d="M8,84.8906 L78,84.8906 L78,91.8906 L68,101.8906 L8,101.8906 L8,84.8906 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="988.0625" style="stroke:#000000;stroke-width:2.0;" width="702" x="8" y="84.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="23" y="97.9575">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="234" x="93" y="97.1011">[if latest off-chain state is finalized]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="124" x2="166" y1="203.8203" y2="203.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="166" x2="166" y1="203.8203" y2="216.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="125" x2="166" y1="216.8203" y2="216.8203"/><polygon fill="#A80036" points="135,212.8203,125,216.8203,135,220.8203,131,216.8203" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="131" y="123.0903">Generate an update on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="131" y="138.2231">parent ledger channel 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="131" y="153.356">(between alice &amp;ingrid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="131" y="168.4888">that unlocks the funds</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="131" y="183.6216">for the virtual channel ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="131" y="198.7544">as per final balance</text><line style="stroke:#A80036;stroke-width:1.0;" x1="524" x2="566" y1="203.8203" y2="203.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="566" x2="566" y1="203.8203" y2="216.8203"/><line style="stroke:#A80036;stroke-width:1.0;" x1="525" x2="566" y1="216.8203" y2="216.8203"/><polygon fill="#A80036" points="535,212.8203,525,216.8203,535,220.8203,531,216.8203" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="531" y="123.0903">Generate an update on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="531" y="138.2231">parent ledger channel 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="531" y="153.356">(between bob &amp;ingrid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="531" y="168.4888">that unlocks the funds</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="531" y="183.6216">for the virtual channel ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="531" y="198.7544">as per final balance</text><polygon fill="#A80036" points="288,257.0859,298,261.0859,288,265.0859,292,261.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="124" x2="294" y1="261.0859" y2="261.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="136" y="240.8872">Send the update on the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="136" y="256.02">parent ledger channel 1</text><path d="M27,273.0859 L97,273.0859 L97,280.0859 L87,290.0859 L27,290.0859 L27,273.0859 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="473.6016" style="stroke:#000000;stroke-width:2.0;" width="552" x="27" y="273.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="42" y="286.1528">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="378" x="112" y="285.2964">[when matching update is received withing expected time]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="27" x2="579" y1="636.4844" y2="636.4844"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="37" x="32" y="646.6948">[else]</text><polygon fill="#A80036" points="311,342.6172,301,346.6172,311,350.6172,307,346.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="305" x2="523" y1="346.6172" y2="346.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="353.5" y="311.2856">(Matching update)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="336" y="326.4185">Send the update on the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="336" y="341.5513">parent ledger channel 2</text><line style="stroke:#A80036;stroke-width:1.0;" x1="300" x2="342" y1="406.0156" y2="406.0156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="342" x2="342" y1="406.0156" y2="419.0156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="301" x2="342" y1="419.0156" y2="419.0156"/><polygon fill="#A80036" points="311,415.0156,301,419.0156,311,423.0156,307,419.0156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="307" y="370.6841">Validate the two updates</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="307" y="385.8169">(Finalized state of virtual channel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="307" y="400.9497">in both must match)</text><path d="M46,431.0156 L116,431.0156 L116,438.0156 L106,448.0156 L46,448.0156 L46,431.0156 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="185.4688" style="stroke:#000000;stroke-width:2.0;" width="508" x="46" y="431.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="61" y="444.0825">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="131" y="443.2261">[if valid]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="46" x2="554" y1="560.5469" y2="560.5469"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="37" x="51" y="570.7573">[else]</text><path d="M67,458.1484 L67,498.1484 L529,498.1484 L529,468.1484 L519,458.1484 L67,458.1484 " fill="#D3D3D3" filter="url(#ffex3ion6fd2u)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M519,458.1484 L519,468.1484 L529,468.1484 L519,458.1484 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="73" y="475.2153">Both participants have already finalized the virtual channel. So,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="73" y="490.3481">automatically accept both updates without involving the user (ingrid).</text><line style="stroke:#A80036;stroke-width:1.0;" x1="300" x2="342" y1="528.5469" y2="528.5469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="342" x2="342" y1="528.5469" y2="541.5469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="301" x2="342" y1="541.5469" y2="541.5469"/><polygon fill="#A80036" points="311,537.5469,301,541.5469,311,545.5469,307,541.5469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="307" y="523.481">Accept</text><line style="stroke:#A80036;stroke-width:1.0;" x1="300" x2="342" y1="595.4844" y2="595.4844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="342" x2="342" y1="595.4844" y2="608.4844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="301" x2="342" y1="608.4844" y2="608.4844"/><polygon fill="#A80036" points="311,604.4844,301,608.4844,311,612.4844,307,608.4844" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="307" y="590.4185">Reject</text><line style="stroke:#A80036;stroke-width:1.0;" x1="300" x2="342" y1="671.4219" y2="671.4219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="342" x2="342" y1="671.4219" y2="684.4219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="301" x2="342" y1="684.4219" y2="684.4219"/><polygon fill="#A80036" points="311,680.4219,301,684.4219,311,688.4219,307,684.4219" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="307" y="666.356">Reject</text><path d="M58,697.4219 L58,737.4219 L538,737.4219 L538,707.4219 L528,697.4219 L58,697.4219 " fill="#D3D3D3" filter="url(#ffex3ion6fd2u)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M528,697.4219 L528,707.4219 L538,707.4219 L528,697.4219 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="459" x="64" y="714.4888">For the participant from whom update was received, reject immediately.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="419" x="64" y="729.6216">For other participants, reject when a matching update is received.</text><path d="M108,759.6875 L172,759.6875 L172,766.6875 L162,776.6875 L108,776.6875 L108,759.6875 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="250" style="stroke:#000000;stroke-width:2.0;" width="558" x="108" y="759.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="123" y="772.7544">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="66" x="187" y="771.8979">[if accept]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="108" x2="666" y1="894.3516" y2="894.3516"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60" x="113" y="904.562">[if reject]</text><polygon fill="#A80036" points="135,814.0859,125,818.0859,135,822.0859,131,818.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="129" x2="299" y1="818.0859" y2="818.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="143" y="797.8872">Accept the update on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="136" y="813.02">parent ledger channel 1</text><polygon fill="#A80036" points="512,814.0859,522,818.0859,512,822.0859,516,818.0859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="300" x2="518" y1="818.0859" y2="818.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="343" y="797.8872">Accept the update on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="336" y="813.02">parent ledger channel 2</text><line style="stroke:#A80036;stroke-width:1.0;" x1="124" x2="166" y1="862.3516" y2="862.3516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="166" x2="166" y1="862.3516" y2="875.3516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="125" x2="166" y1="875.3516" y2="875.3516"/><polygon fill="#A80036" points="135,871.3516,125,875.3516,135,879.3516,131,875.3516" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="131" y="842.1528">Virtual channel is</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="131" y="857.2856">withdrawn for alice</text><line style="stroke:#A80036;stroke-width:1.0;" x1="524" x2="566" y1="862.3516" y2="862.3516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="566" x2="566" y1="862.3516" y2="875.3516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="525" x2="566" y1="875.3516" y2="875.3516"/><polygon fill="#A80036" points="535,871.3516,525,875.3516,535,879.3516,531,875.3516" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="531" y="842.1528">Virtual channel is</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="531" y="857.2856">withdrawn for bob</text><polygon fill="#A80036" points="135,940.4219,125,944.4219,135,948.4219,131,944.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="129" x2="299" y1="944.4219" y2="944.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="145.5" y="924.2231">Reject the update on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="136" y="939.356">parent ledger channel 1</text><polygon fill="#A80036" points="512,940.4219,522,944.4219,512,948.4219,516,944.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="300" x2="518" y1="944.4219" y2="944.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="345.5" y="924.2231">Reject the update on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="336" y="939.356">parent ledger channel 2</text><line style="stroke:#A80036;stroke-width:1.0;" x1="124" x2="166" y1="988.6875" y2="988.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="166" x2="166" y1="988.6875" y2="1001.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="125" x2="166" y1="1001.6875" y2="1001.6875"/><polygon fill="#A80036" points="135,997.6875,125,1001.6875,135,1005.6875,131,1001.6875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="131" y="968.4888">Virtual channel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="131" y="983.6216">withdrawal failed</text><line style="stroke:#A80036;stroke-width:1.0;" x1="524" x2="566" y1="988.6875" y2="988.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="566" x2="566" y1="988.6875" y2="1001.6875"/><line style="stroke:#A80036;stroke-width:1.0;" x1="525" x2="566" y1="1001.6875" y2="1001.6875"/><polygon fill="#A80036" points="535,997.6875,525,1001.6875,535,1005.6875,531,1001.6875" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="531" y="968.4888">Virtual channel</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="531" y="983.6216">withdrawal failed</text><path d="M82.5,1023.6875 L82.5,1063.6875 L565.5,1063.6875 L565.5,1033.6875 L555.5,1023.6875 L82.5,1023.6875 " fill="#D3D3D3" filter="url(#ffex3ion6fd2u)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M555.5,1023.6875 L555.5,1033.6875 L565.5,1033.6875 L555.5,1023.6875 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="161.5" y="1040.7544">In this case, the virtual channel should be settled</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="161.5" y="1055.8872">by registering a dispute on the blockchain.</text><!--MD5=[da82ae0fe854d759fa97e4a26472295e]
@startuml settle_withdraw_virtual
!pragma teoz true
hide footbox
skinparam SequenceMessageAlign center

participant "Alice\n(Proposer)" as alice
participant "Ingrid\n(Common\nIntermediary)" as ingrid
participant "Bob\n(Proposee)" as bob

opt if latest off-chain state is finalized
alice -> alice: Generate an update on\nparent ledger channel 1\n(between alice &ingrid)\nthat unlocks the funds\nfor the virtual channel ID\nas per final balance
&bob -> bob: Generate an update on\nparent ledger channel 2\n(between bob &ingrid)\nthat unlocks the funds\nfor the virtual channel ID\nas per final balance

alice -> ingrid: Send the update on the\nparent ledger channel 1

opt when matching update is received withing expected time
ingrid <- bob: (Matching update)\nSend the update on the\nparent ledger channel 2

ingrid -> ingrid: Validate the two updates\n(Finalized state of virtual channel\nin both must match)

opt if valid
note over ingrid #LightGray
Both participants have already finalized the virtual channel. So,
automatically accept both updates without involving the user (ingrid).
end note
ingrid -> ingrid: Accept
else else
ingrid -> ingrid: Reject
end

else else
ingrid -> ingrid: Reject
note over ingrid #LightGray
For the participant from whom update was received, reject immediately.
For other participants, reject when a matching update is received.
end note
end

alt if accept
alice <- ingrid: Accept the update on\nparent ledger channel 1
&ingrid -> bob: Accept the update on\nparent ledger channel 2

alice -> alice: Virtual channel is\nwithdrawn for alice
&bob -> bob: Virtual channel is\nwithdrawn for bob

else if reject
alice <- ingrid: Reject the update on\nparent ledger channel 1
&ingrid -> bob: Reject the update on\nparent ledger channel 2

alice -> alice: Virtual channel \nwithdrawal failed
&bob -> bob: Virtual channel \nwithdrawal failed
end
note over alice, bob #LightGray
In this case, the virtual channel should be settled
by registering a dispute on the blockchain.
end note

end

@enduml

PlantUML version 1.2020.21(Mon Nov 30 22:10:11 IST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: IN
--></g></svg>